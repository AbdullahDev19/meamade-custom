import Tabs from "@theme/Tabs"
import TabItem from "@theme/TabItem"
import { Table } from "docs-ui"

# Payment Module

The Payment Module is the `@medusajs/payment` NPM package that provides payment-related features in your Medusa and Node.js applications.

---

## Features

### Add Payment Functionalities to Any Resource

The Payment Module provides payment functionalities that allow you to process payment of any resource, such as a cart.

All payment processing starts with creating a payment collection.

```ts
const paymentCollection =
  await paymentModuleService.createPaymentCollections({
    region_id: "reg_123",
    currency_code: "usd",
    amount: 5000,
  })
```

### Authorize, Capture, and Refund Payment

The Payment Module provides essential features to receive and handle payments, including authorizing, capturing, and refunding payment.

```ts
await paymentModuleService.capturePayment({
  payment_id: "pay_1",
})
```

### Integrate Third-Party Payment Providers

Use payment providers like Stripe and PayPal to handle and process payments.

```ts
const payment =
  await paymentModuleService.createPaymentSession(
    "pay_col_1",
    {
      provider_id: "stripe",
      amount: 1000,
      currency_code: "usd",
      data: {
        // necessary data for the payment provider
      },
    }
  )
```

### Handle Webhook Events

The Payment Module allows you to handle webhook events from third-party providers and process the associated payment.

```ts
await paymentModuleService.processEvent({
  provider: "stripe",
  payload: {
    // webhook payload
  },
})
```

---

## Configure Payment Module

After installing the `@medusajs/payment` package in your Medusa application, add it to the `modules` object in `medusa-config.js`:

```js title="medusa-config.js"
const modules = {
  // ...
  apiKey: {
    resolve: "@medusajs/payment",
    options: {
      // ...
    },
  },
}
```

### Module Options

<Table>
  <Table.Header>
    <Table.Row>
      <Table.HeaderCell>Option</Table.HeaderCell>
      <Table.HeaderCell>Description</Table.HeaderCell>
      <Table.HeaderCell>Required</Table.HeaderCell>
      <Table.HeaderCell>Default</Table.HeaderCell>
    </Table.Row>
  </Table.Header>
  <Table.Body>
    <Table.Row>
      <Table.Cell>
      
      `webhook_delay`
      
      </Table.Cell>
      <Table.Cell>
      
      A number indicating the delay in milliseconds before processing a webhook event.
      
      </Table.Cell>
      <Table.Cell>
      
      No
      
      </Table.Cell>
      <Table.Cell>
      
      `5000`
      
      </Table.Cell>
    </Table.Row>
    <Table.Row>
      <Table.Cell>
      
      `webhook_retries`
      
      </Table.Cell>
      <Table.Cell>
      
      The number of times to retry the webhook event processing in case of an error.
      
      </Table.Cell>
      <Table.Cell>
      
      No
      
      </Table.Cell>
      <Table.Cell>
      
      `3`
      
      </Table.Cell>
    </Table.Row>
    <Table.Row>
      <Table.Cell>
      
      `providers`
      
      </Table.Cell>
      <Table.Cell>
      
      An array of payment providers to install and register. Learn more [here](./payment-provider/index.mdx#configure-payment-providers).
      
      </Table.Cell>
      <Table.Cell>
      
      No
      
      </Table.Cell>
      <Table.Cell>
      
      \-
      
      </Table.Cell>
    </Table.Row>
  </Table.Body>
</Table>

---

## How to Use Payment Module's Service

You can use the Payment Module's main service by resolving from the dependency container the resource `ModuleRegistrationName.PAYMENT` imported from `@medusajs/modules-sdk`.

For example:

<Tabs groupId="resource-type" isCodeTabs={true}>
  <TabItem label="API Route" value="api-route" attributes={{
    title: "src/api/store/custom/route.ts"
  }}>

  ```ts
  import { MedusaRequest, MedusaResponse } from "@medusajs/medusa"
  import { IPaymentModuleService } from "@medusajs/types"
  import { ModuleRegistrationName } from "@medusajs/modules-sdk"

  export async function GET(
    req: MedusaRequest,
    res: MedusaResponse
  ): Promise<void> {
    const paymentModuleService: IPaymentModuleService =
      req.scope.resolve(ModuleRegistrationName.PAYMENT)

    res.json({
      payment_collections:
        await paymentModuleService.listPaymentCollections(),
    })
  }
  ```

  </TabItem>
  <TabItem label="Subscriber" value="subscribers" attributes={{
    title: "src/subscribers/custom-handler.ts"
  }}>

  ```ts
  import { SubscriberArgs } from "@medusajs/medusa"
  import { IPaymentModuleService } from "@medusajs/types"
  import { ModuleRegistrationName } from "@medusajs/modules-sdk"

  export default async function subscriberHandler({
    container,
  }: SubscriberArgs) {
    const paymentModuleService: IPaymentModuleService =
      container.resolve(ModuleRegistrationName.API_KEY)

    const payment_collections =
      await paymentModuleService.listPaymentCollections()
  }
  ```

  </TabItem>
  <TabItem label="Workflow Step" value="workflow-step" attributes={{
    title: "src/workflows/hello-world/step1.ts"
  }}>

  ```ts
  import { createStep } from "@medusajs/workflows-sdk"
  import { IPaymentModuleService } from "@medusajs/types"
  import { ModuleRegistrationName } from "@medusajs/modules-sdk"

  const step1 = createStep("step-1", async (_, context) => {
    const paymentModuleService: IPaymentModuleService =
      context.container.resolve(
        ModuleRegistrationName.API_KEY
      )

    const payment_collections =
      await paymentModuleService.listPaymentCollections()
  })
  ```

  </TabItem>
</Tabs>
